<!DOCTYPE HTML>
<html>
<head>
<script src="engine/utils.js" type="text/javascript"></script>
<script src="engine/sortedlist.js" type="text/javascript"></script>
<script src="engine/vectorutils.js" type="text/javascript"></script>
<script src="engine/transform.js" type="text/javascript"></script>
<script src="engine/loc.js" type="text/javascript"></script>
<script src="engine/renderutils.js" type="text/javascript"></script>
<script src="engine/color.js" type="text/javascript"></script>
<script src="engine/node.js" type="text/javascript"></script>
<script src="engine/nodeloader.js" type="text/javascript"></script>
<script src="engine/renderlist.js" type="text/javascript"></script>
<script src="engine/mousehandler.js" type="text/javascript"></script>
<script src="engine/scene.js" type="text/javascript"></script>
<script src="engine/camera.js" type="text/javascript"></script>
<script src="engine/sprite.js" type="text/javascript"></script>
<script src="engine/frameanimation.js" type="text/javascript"></script>
<script src="engine/linearaction.js" type="text/javascript"></script>
<script src="engine/button.js" type="text/javascript"></script>
<script src="engine/progress.js" type="text/javascript"></script>
<script src="engine/label.js" type="text/javascript"></script>

<script src="game/player.js" type="text/javascript"></script>
<script src="game/roomscene.js" type="text/javascript"></script>
<script src="game/barscene.js" type="text/javascript"></script>
<script src="game/streetscene.js" type="text/javascript"></script>
<script src="game/supermarket_outside_scene.js" type="text/javascript"></script>
<script src="game/supermarket_inside_scene.js" type="text/javascript"></script>
<script src="game/uiscene.js" type="text/javascript"></script>
<script src="game/clock.js" type="text/javascript"></script>

<script type="text/javascript">
	'use strict';
	
	window.requestAnimFrame = (function () {
		return window.requestAnimationFrame ||
			window.webkitRequestAnimationFrame ||
			window.mozRequestAnimationFrame ||
			window.oRequestAnimationFrame ||
			window.msRequestAnimationFrame ||
			function(callback){
				window.setTimeout(callback, 1000 / 60);
			};
	}) ();

    var g_canvas;

	var g_fps = 0;
	var g_frames = 0;
	var g_framesTime = 0.0;
	
	var g_mouse = {x: 0, y: 0, down: false};
	
	var g_camera;
	var g_clock = new Clock(new Date());
	
	var g_roomScene;
	var g_streetScene;
	var g_barScene;
	var g_uiScene;
	var g_supermarketOutsideScene;
	var g_supermarketInsideScene;
	var g_root;
	var g_player;
	
	function animate(lastTime, canvas, context){
		// update
		var time = window.performance.now();
		var timeDiff = (time - lastTime) * 0.001;
		lastTime = time;
		
		// update fps
		g_framesTime += timeDiff;
		g_frames++;
		if (g_framesTime > 1.0) {
			g_framesTime -= 1.0;
			g_fps = g_frames;
			g_frames = 0;
		}
		
		// update
		g_clock.advance(10 * timeDiff / 60);
		g_root.update(timeDiff);
		
        var worldMousePos = g_camera.screenToWorld(g_mouse);

		// clear
		context.fillStyle = "#003000";
		context.fillRect(0, 0, canvas.width, canvas.height);
		
		// draw scene
		g_root.render(context);
		
		// draw fps
		context.font = "20pt Comic Sans MS";
		context.fillStyle = "#FF0000";
		context.strokeStyle = "#FF0000";
		context.lineWidth = 1;
		var fpsText = "FPS: " + g_fps;
		context.fillText(fpsText, 5, 25);
		
		// draw mouse coordinates
		var mouseText = g_mouse.x + ", " + g_mouse.y;
		context.fillText(mouseText, 900, 25);
		
		// draw clock
		context.fillStyle = "#000000";
		context.fillText(g_clock.toString(), 682, 752);
		context.fillStyle = "#FFFFFF";
		context.fillText(g_clock.toString(), 680, 750);
		
		// request new frame
		requestAnimFrame(function(){
			animate(lastTime, canvas, context);
		});
	}

    function extractMouseCoords(canvas, evt){
        // get canvas position
        var obj = canvas;
        var top = 0;
        var left = 0;
        while (obj && obj.tagName != 'BODY') {
            top += obj.offsetTop;
            left += obj.offsetLeft;
            obj = obj.offsetParent;
        }

        // return relative mouse position
        var mouseX = evt.clientX - left + window.pageXOffset;
        var mouseY = evt.clientY - top + window.pageYOffset;
        return {
            x: mouseX,
            y: mouseY
        };
    }

	function handleMouseEvent(event, isDown, type) {
		var coords = extractMouseCoords(g_canvas, event);
		g_mouse.x = coords.x;
		g_mouse.y = coords.y;
		g_mouse.down = isDown;

		var transformedEvent = {x: g_mouse.x, y: g_mouse.y, down: g_mouse.down};
		Vec.set(transformedEvent, g_root.getTransform().inverse().apply(transformedEvent));
		g_root[type](transformedEvent);
	}

	function handleMouseDown(event) {
		handleMouseEvent(event, true, 'mouseDown');
	}

	function handleMouseUp(event) {
		handleMouseEvent(event, false, 'mouseUp');
	}

	function handleMouseMove(event) {
		handleMouseEvent(event, g_mouse.down, 'mouseMove');
	}

	window.onload = function() {
		g_canvas = document.getElementById("myCanvas");
		var context = g_canvas.getContext("2d");

		g_camera = new Camera(-g_canvas.width * 0.5, -g_canvas.height * 0.5, 0, 1, 1);
		
		g_canvas.addEventListener('mousedown', handleMouseDown, false);
		g_canvas.addEventListener('mousemove', handleMouseMove, false);
		g_canvas.addEventListener('mouseup', handleMouseUp, false);
		
		g_player = new Player();
		g_roomScene = new RoomScene();
		g_roomScene.onExitToStreet = function() {
			g_root.children[0] = g_streetScene; 
			g_root.init();
			var playerBody = g_player.body = g_streetScene.playerBody;
			playerBody.pos = new Pos(850, 280);
			playerBody.scale = new Size(-0.5, 0.5);
			playerBody.z = 0;
		};
		g_roomScene.onSleep = function() {
			g_player.saturation -= 10;
			g_player.energy += 5;
		}
		
		g_barScene = new BarScene();
		g_barScene.onExitToStreet = function() {
			g_root.children[0] = g_streetScene; 
			g_root.init();
			var playerBody = g_player.body = g_streetScene.playerBody;
			playerBody.pos = new Pos(100, 170);
			playerBody.scale = new Size(0.6, 0.6);
			playerBody.z = 0;
		}
		g_barScene.onEatDoener = function() {
			if (g_player.money >= 3.2) {
				g_player.saturation += 10;
				g_player.money -= 3.2;
			}
		}
		
		g_streetScene = new StreetScene();
		g_streetScene.onEnterHome = function() {
			g_root.children[0] = g_roomScene;
			g_root.init();
		};
		g_streetScene.onEnterBar = function() {
			g_root.children[0] = g_barScene;
			g_root.init();
		};
		g_streetScene.onExitToSupermarket = function() {
			g_root.children[0] = g_supermarketOutsideScene;
			g_root.init();
		};
		g_supermarketOutsideScene = new SupermarketOutsideScene();
		g_supermarketOutsideScene.onEnterSupermarket = function() {
		};
		g_supermarketOutsideScene.onExitToStreet = function() {
			g_root.children[0] = g_streetScene;
			g_root.init();
			var playerBody = g_player.body = g_streetScene.playerBody;
			playerBody.pos = new Pos(60, 170);
			playerBody.scale = new Size(0.5, 0.5);
			playerBody.z = 0;
		};
		g_supermarketOutsideScene.onEnterSupermarket = function() {
			g_root.children[0] = g_supermarketInsideScene;
			g_root.init();
		};
		g_supermarketInsideScene = new SupermarketInsideScene();
		
		g_uiScene = new UIScene();
		g_player.onValueChanged = function(valueName, newValue) {
			switch (valueName) {
				case 'energy':
					g_uiScene.energyProgress.progress = newValue * 0.01;
					break;
				case 'saturation':
					g_uiScene.saturationProgress.progress = newValue * 0.01;
					break;
				case 'fun':
					g_uiScene.funProgress.progress = newValue * 0.01;
					break;
				case 'money':
					g_uiScene.moneyAmountLabel.text = newValue.toFixed(2) + '€';
					break;
			}
		}
		g_player.energy = 80;
		g_player.saturation = 75;
		g_player.fun = 5;
		g_player.money = 391;
		
		g_root = new Scene();
		g_root.addChild(g_supermarketOutsideScene);
		g_root.addChild(g_uiScene);
		var playerBody = g_player.body = g_supermarketOutsideScene.playerBody;
		playerBody.pos = new Pos(1000, 680);
		playerBody.scale = new Size(-0.8, 0.8);
		playerBody.z = 0;
		g_root.init();
		
		animate(window.performance.now(), g_canvas, context);
	};
</script>
</head>
<body>
	<canvas id="myCanvas" width="1024" height="768"></canvas>
</body>
</html>
