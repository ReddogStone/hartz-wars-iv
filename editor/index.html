<html>
<head>
	<title>My first Three.js app</title>
	
	<script src="utils.js" type="text/javascript"></script>
	<script src="fileutils.js" type="text/javascript"></script>
	<script src="webgl_utils.js" type="text/javascript"></script>
	<script src="engine3d.js" type="text/javascript"></script>
	<script src="mesh.js" type="text/javascript"></script>
	<script src="material.js" type="text/javascript"></script>
	<script src="scene.js" type="text/javascript"></script>
	<script src="color.js" type="text/javascript"></script>
	<script src="point_light.js" type="text/javascript"></script>

	<script src="sprite_renderable.js" type="text/javascript"></script>
	<script src="text_renderable.js" type="text/javascript"></script>
	<script src="transformable.js" type="text/javascript"></script>
	
	<script src="Matrix3.js" type="text/javascript"></script>
	<script src="Matrix4.js" type="text/javascript"></script>
	<script src="Vector3.js" type="text/javascript"></script>
	<script src="Vector4.js" type="text/javascript"></script>
	<script src="Quaternion.js" type="text/javascript"></script>
</head>
<body>
<canvas id="canvas" width="1024" height="768"></canvas>

<script>
	var lastTime = window.performance.now();
	var g_fps = 0;
	var g_frames = 0;
	var g_framesTime = 0;
	
	window.requestAnimFrame = (function () {
		return window.requestAnimationFrame ||
			window.webkitRequestAnimationFrame ||
			window.mozRequestAnimationFrame ||
			window.oRequestAnimationFrame ||
			window.msRequestAnimationFrame ||
			function(callback){
				window.setTimeout(callback, 1000 / 60);
			};
	}) ();
	
	function render() {
		var time = window.performance.now();
		var delta = (time - lastTime) * 0.001;
		lastTime = time;
		
		// update fps
		g_framesTime += delta;
		g_frames++;
		if (g_framesTime > 1.0) {
			g_framesTime -= 1.0;
			g_fps = g_frames;
			g_frames = 0;
		}
		fpsLabel.renderable.text = 'FPS: ' + g_fps;
	
		var spr1Transform = sprite1.transformable;		
		spr1Transform.pos = new Vecmath.Vector3(0, 2 * Math.sin(0.001 * time), 2 * Math.cos(0.001 * time));
		
		label.renderable.text = '' + time;
		
		Engine3D.clear();
		scene.render(Engine3D);
		
		requestAnimFrame( function() { render(); } );
	}

	var canvas = document.getElementById('canvas');
	Engine3D.init(canvas);
	
	var view = new Vecmath.Matrix4().lookAt(new Vecmath.Vector3(0, 0, 2),
			new Vecmath.Vector3(0, 0, 0),
			new Vecmath.Vector3(0, 1, 0));
	var projection = new Vecmath.Matrix4().perspective(0.5 * Math.PI, canvas.width / canvas.height, 0.01, 1000);
	var scene = new Scene(new Viewport(), view, projection);
//	scene.pointLight1 = new PointLight(new Vecmath.Vector3(1, 0, 0.1), Color.white);
//	scene.pointLight2 = new PointLight(new Vecmath.Vector3(0, 0, 10), new Color(1, 1, 1));
	
	var sprite1 = {
		renderable: new SpriteRenderable(Engine3D, 'data/textures/node2.png'),
		transformable: new Transformable()
	};
	var sprite2 = {
		renderable: new SpriteRenderable(Engine3D, 'data/textures/node2.png'),
		transformable: new Transformable(new Vecmath.Vector3(0, 0, 0), null, new Vecmath.Vector3(1, 1, 1))
	};
	var label = {
		renderable: new TextRenderable(Engine3D, 'TengaliumMMM', new Font('Georgia', 32), Color.green),
		transformable: new Transformable(new Vecmath.Vector3(0, 0, 1))
	};
	var fpsLabel = {
		renderable: new ScreenTextRenderable(Engine3D, '', new Font('Georgia', 20), Color.white),
		transformable: new Transformable(new Vecmath.Vector3(10, 727, 0))
	};
	
	var mat = sprite1.renderable.material;
	mat.color = new Color(0.5, 0.5, 1);
	mat.luminosity = 1;
	
	var mat = sprite2.renderable.material;
	mat.color = Color.blue;
	mat.luminosity = 1;

	var mat = label.renderable.material;
	mat.luminosity = 1;

	var mat = fpsLabel.renderable.material;
	mat.luminosity = 1;
	
	scene.addEntity(sprite1);
	scene.addEntity(sprite2);
	scene.addEntity(label);
	scene.addEntity(fpsLabel);
	
	requestAnimFrame(function() { render(); });
	alert('OK')
</script>
</body>
</html>