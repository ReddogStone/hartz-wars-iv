<!DOCTYPE HTML>
<html>
<head>
	<meta charset="UTF-8"/>
	<title>Hartz Wars IV - Editor</title>
	
	<script src="../math/Matrix3.js" type="text/javascript"></script>
	<script src="../math/Matrix4.js" type="text/javascript"></script>
	<script src="../math/Vector2.js" type="text/javascript"></script>
	<script src="../math/Vector3.js" type="text/javascript"></script>
	<script src="../math/Vector4.js" type="text/javascript"></script>
	<script src="../math/Quaternion.js" type="text/javascript"></script>
	<script src="../math/Ray.js" type="text/javascript"></script>
	<script src="../math/Mathutils.js" type="text/javascript"></script>

	<script src="../3dengine/webgl-debug.js" type="text/javascript"></script>
	<script src="../3dengine/utils.js" type="text/javascript"></script>
	<script src="../3dengine/fileutils.js" type="text/javascript"></script>
	<script src="../3dengine/webgl_utils.js" type="text/javascript"></script>
	<script src="../3dengine/engine3d.js" type="text/javascript"></script>
	<script src="../3dengine/mesh.js" type="text/javascript"></script>
	<script src="../3dengine/material.js" type="text/javascript"></script>
	<script src="../3dengine/scene.js" type="text/javascript"></script>
	<script src="../3dengine/color.js" type="text/javascript"></script>
	<script src="../3dengine/point_light.js" type="text/javascript"></script>
	<script src="../3dengine/camera.js" type="text/javascript"></script>
	<script src="../3dengine/texture_atlas.js" type="text/javascript"></script>

	<script src="../3dengine/sprite_renderable.js" type="text/javascript"></script>
	<script src="../3dengine/text_renderable.js" type="text/javascript"></script>
	<script src="../3dengine/instanced_renderable.js" type="text/javascript"></script>
	<script src="../3dengine/transformable.js" type="text/javascript"></script>
	<script src="../3dengine/behaviors_updateable.js" type="text/javascript"></script>

	<script src="../node_ui/hierarchical_view.js" type="text/javascript"></script>
	<script src="../node_ui/layout.js" type="text/javascript"></script>
	<script src="../node_ui/widget.js" type="text/javascript"></script>
	<script src="../node_ui/uinode.js" type="text/javascript"></script>
	<script src="../node_ui/node_tree.js" type="text/javascript"></script>
	<script src="../node_ui/dialog_overview_controller.js" type="text/javascript"></script>
	
	<script src="../profiler/profiler.js" type="text/javascript"></script>
</head>
<body>
<canvas id="canvas" width="1024" height="768"></canvas>

<script>
	console.log('ß');

	const BLUE = new Color(0.3, 0.5, 0.7);
	const RED = new Color(0.7, 0.0, 0.0);
	const HIGHLIGHTED = new Color(1.0, 0.2, 0.2);
	const PROFILER_LINES = 50;

	var g_canvas;
	var g_camEntity;
	var g_scene;
	var g_fpsLabel;
	var g_mousePosLabel;
	var lastTime = window.performance.now();
	var g_fps = 0;
	var g_frames = 0;
	var g_framesTime = 0;
	var g_mouse = {x: 0, y: 0, down: false};
	var g_viewport;
	var g_controller;
	var g_profileLines = [];
	
	window.requestAnimFrame = (function () {
		return window.requestAnimationFrame ||
			window.webkitRequestAnimationFrame ||
			window.mozRequestAnimationFrame ||
			window.oRequestAnimationFrame ||
			window.msRequestAnimationFrame ||
			function(callback){
				window.setTimeout(callback, 1000 / 60);
			};
	}) ();
	
	function animate() {
		FrameProfiler.startFrame();
	
		var time = window.performance.now();
		var delta = (time - lastTime) * 0.001;
		lastTime = time;
		
		// update fps
		g_framesTime += delta;
		g_frames++;
		if (g_framesTime > 1.0) {
			g_framesTime -= 1.0;
			g_fps = g_frames;
			g_frames = 0;
		}

		g_fpsLabel.renderable.text = 'FPß: ' + g_fps;
		g_mousePosLabel.renderable.text = 'Mouse: (' + g_mouse.x + ', ' + g_mouse.y + ', ' + (g_mouse.down ? 'down' : 'up') + ')';
		
		FrameProfiler.start('UpdateAll');
		g_controller.update(delta);
		FrameProfiler.stop();
		
		Engine3D.clear();
		
		FrameProfiler.start('RenderAll');
		g_controller.render(Engine3D);
		FrameProfiler.stop();
		
		FrameProfiler.stopFrame();
		var lines = FrameProfiler.getReportStrings();
		g_profileLines.forEach(function(profileLine, index) {
			var text = lines[lines.length - 1 - index] || '';
			if (text) {
				profileLine.renderable.invisible = false;
				profileLine.renderable.text = text;
			} else {
				profileLine.renderable.invisible = true;
			}
		});
		
		g_scene.render(Engine3D, g_viewport, g_camEntity);
		
		requestAnimFrame( function() { animate(); } );
	}
	
    function extractMouseCoords(canvas, evt){
        // get canvas position
        var obj = canvas;
        var top = 0;
        var left = 0;
        while (obj && obj.tagName != 'BODY') {
            top += obj.offsetTop;
            left += obj.offsetLeft;
            obj = obj.offsetParent;
        }

        // return relative mouse position
        var mouseX = evt.clientX - left + window.pageXOffset;
        var mouseY = evt.clientY - top + window.pageYOffset;
        return {
            x: mouseX,
            y: mouseY
        };
    }

	var g_drag = {x: 0, y: 0};
	var g_click = false;
	
	function handleMouseEvent(event, isDown, type) {
		var coords = extractMouseCoords(canvas, event);
		g_mouse.x = coords.x;
		g_mouse.y = coords.y;
		g_mouse.down = isDown;
		
		g_controller.view[type](g_mouse);
	}

	function handleMouseDown(event) {
		handleMouseEvent(event, true, 'mouseDown');
	}

	function handleMouseUp(event) {
		handleMouseEvent(event, false, 'mouseUp');
	}

	function handleMouseMove(event) {
		handleMouseEvent(event, g_mouse.down, 'mouseMove');
	}
	
	function handleKeyDown(event) {
		g_controller.view.keyDown(event);
	}
	function handleKeyPress(event) {
		g_controller.view.keyPress(event);
	}
	function handleKeyUp(event) {
		g_controller.view.keyUp(event);
	}

	function start() {
		g_canvas = document.getElementById('canvas');
		
		Engine3D.init(g_canvas);
		Engine3D.setClearColor(new Color(0.1, 0.1, 0.1));
		
		Engine3D.createProgram('simple',
			FileUtils.loadFile('data/shaders/simple_vs.shader'),
			FileUtils.loadFile('data/shaders/simple_fs.shader'));
		Engine3D.createProgram('screenspace',
			FileUtils.loadFile('data/shaders/screenspace_vs.shader'),
			FileUtils.loadFile('data/shaders/screenspace_fs.shader'));
		Engine3D.createProgram('text',
			FileUtils.loadFile('data/shaders/text_vs.shader'),
			FileUtils.loadFile('data/shaders/screenspace_fs.shader'));
		Engine3D.createProgram('pointsprite',
			FileUtils.loadFile('data/shaders/pointsprite_vs.shader'),
			FileUtils.loadFile('data/shaders/screenspace_fs.shader'));
		Engine3D.createProgram('line',
			FileUtils.loadFile('data/shaders/line_vs.shader'),
			FileUtils.loadFile('data/shaders/screenspace_fs.shader'));
		Engine3D.createProgram('pointsprite_instanced',
			FileUtils.loadFile('data/shaders/pointsprite_instanced_vs.shader'),
			FileUtils.loadFile('data/shaders/screenspace_instanced_fs.shader'));
			
		Engine3D.createTextureFromFile('data/textures/node', 'data/textures/node.png');
		Engine3D.createTextureFromFile('data/textures/new_icon', 'data/textures/new_icon.png');
		Engine3D.createTextureFromFile('data/textures/load_icon', 'data/textures/load_icon.png');
		Engine3D.createTextureFromFile('data/textures/save_icon', 'data/textures/save_icon.png');
		Engine3D.createTextureFromFile('data/textures/help_icon', 'data/textures/help_icon.png');
		Engine3D.createTextureFromFile('data/textures/line_pattern', 'data/textures/line_pattern.png');
		Engine3D.createTextureFromFile('data/textures/object_icon', 'data/textures/object_icon.png');
		Engine3D.createTextureFromFile('data/textures/array_icon', 'data/textures/array_icon.png');
		Engine3D.createTextureFromFile('data/textures/number_icon', 'data/textures/number_icon.png');
		Engine3D.createTextureFromFile('data/textures/string_icon', 'data/textures/string_icon.png');
		Engine3D.createTextureFromFile('data/textures/function_icon', 'data/textures/function_icon.png');
		Engine3D.createTextureFromFile('data/textures/null_icon', 'data/textures/null_icon.png');
		Engine3D.createTextureFromFile('data/textures/boolean_icon', 'data/textures/boolean_icon.png');
		Engine3D.createTextureFromFile('data/textures/container_icon', 'data/textures/container_icon.png');
		Engine3D.createTextureFromFile('data/textures/file_icon', 'data/textures/file_icon.png');
		Engine3D.createTextureFromFile('data/textures/directory_icon', 'data/textures/directory_icon.png');
		Engine3D.createTextureFromFile('data/textures/none_icon', 'data/textures/none_icon.png');
		Engine3D.createTextureFromFile('data/textures/bg_box', 'data/textures/bg_box.png');
		Engine3D.createTextureFromFile('data/textures/icon_atlas', 'data/textures/icon_atlas.png');
		Engine3D.createTextureFromFile('data/textures/full_line_pattern', 'data/textures/full_line_pattern.png');
		
		g_viewport = new Viewport();
		
		g_camEntity = {
			camera: new Camera(0.5 * Math.PI, g_canvas.clientWidth / g_canvas.clientHeight, 0.01, 1000),
			transformable: new Transformable(new Vecmath.Vector3(0, 0, 10))
		};
		g_camEntity.camera.target = new Vecmath.Vector3(0, 0, 0);

		g_scene = new Scene();

		g_fpsLabel = {
			renderable: new ScreenTextRenderable(Engine3D, '', new Font('Georgia', 14), Color.white),
			transformable: new Transformable(new Vecmath.Vector3(10, 727, 0))
		};
		g_scene.addEntity(g_fpsLabel);

		for (var i = 0; i < PROFILER_LINES; ++i) {
			var profileLineLabel = {
				renderable: new ScreenTextRenderable(Engine3D, '', new Font('Lucida Console', 10), Color.white),
				transformable: new Transformable(new Vecmath.Vector3(10, i * 12, 0))
			};
			g_scene.addEntity(profileLineLabel);
			g_profileLines.push(profileLineLabel);
		}
		
		
		g_mousePosLabel = {
			renderable: new ScreenTextRenderable(Engine3D, '', new Font('Georgia', 14), Color.white),
			transformable: new Transformable(new Vecmath.Vector3(800, 727, 0))
		};
		g_scene.addEntity(g_mousePosLabel);
		
		var instancedTest = {
			renderable: new PointSpriteBatchRenderable(Engine3D, 'data/textures/icon_atlas', new AtlasDesc(8, 8)),
			transformable: new Transformable(new Vecmath.Vector3(0, 0, 0))
		};
//		g_scene.addEntity(instancedTest);		
		
		g_controller = new DialogOverviewController(Engine3D, g_viewport);
		
		g_canvas.addEventListener('mousedown', handleMouseDown, false);
		g_canvas.addEventListener('mousemove', handleMouseMove, false);
		g_canvas.addEventListener('mouseup', handleMouseUp, false);
		
		document.onkeydown = handleKeyDown;
		document.onkeypress = handleKeyPress;
		document.onkeyup = handleKeyUp;
		
		requestAnimFrame(function() { animate(); });
	}
	
	start();
</script>
</body>
</html>