<html>
<head>
	<title>My first Three.js app</title>
	
	<script src="utils.js" type="text/javascript"></script>
	<script src="fileutils.js" type="text/javascript"></script>
	<script src="webgl_utils.js" type="text/javascript"></script>
	<script src="engine3d.js" type="text/javascript"></script>
	<script src="mesh.js" type="text/javascript"></script>
	<script src="material.js" type="text/javascript"></script>
	<script src="scene.js" type="text/javascript"></script>
	<script src="color.js" type="text/javascript"></script>
	<script src="point_light.js" type="text/javascript"></script>
	<script src="camera.js" type="text/javascript"></script>

	<script src="sprite_renderable.js" type="text/javascript"></script>
	<script src="text_renderable.js" type="text/javascript"></script>
	<script src="transformable.js" type="text/javascript"></script>
	
	<script src="Matrix3.js" type="text/javascript"></script>
	<script src="Matrix4.js" type="text/javascript"></script>
	<script src="Vector2.js" type="text/javascript"></script>
	<script src="Vector3.js" type="text/javascript"></script>
	<script src="Vector4.js" type="text/javascript"></script>
	<script src="Quaternion.js" type="text/javascript"></script>
</head>
<body>
<canvas id="canvas" width="1024" height="768"></canvas>

<script>
	var g_canvas;
	var g_camEntity;
	var g_scene;
	var g_fpsLabel;
	var g_mousePosLabel;
	var lastTime = window.performance.now();
	var g_fps = 0;
	var g_frames = 0;
	var g_framesTime = 0;
	var g_mouse = {x: 0, y: 0, down: false};
	
	window.requestAnimFrame = (function () {
		return window.requestAnimationFrame ||
			window.webkitRequestAnimationFrame ||
			window.mozRequestAnimationFrame ||
			window.oRequestAnimationFrame ||
			window.msRequestAnimationFrame ||
			function(callback){
				window.setTimeout(callback, 1000 / 60);
			};
	}) ();
	
	function render() {
		var time = window.performance.now();
		var delta = (time - lastTime) * 0.001;
		lastTime = time;
		
		// update fps
		g_framesTime += delta;
		g_frames++;
		if (g_framesTime > 1.0) {
			g_framesTime -= 1.0;
			g_fps = g_frames;
			g_frames = 0;
		}
		g_fpsLabel.renderable.text = 'FPS: ' + g_fps;
		
		g_mousePosLabel.renderable.text = 'Mouse: (' + g_mouse.x + ', ' + g_mouse.y + ', ' + (g_mouse.down ? 'down' : 'up') + ')';
		
//		camera.transformable.pos = new Vecmath.Vector3(10 * Math.sin(0.001 * time), 5, 10);
	
		Engine3D.clear();
		g_scene.render(Engine3D);
		
		requestAnimFrame( function() { render(); } );
	}
	
    function extractMouseCoords(canvas, evt){
        // get canvas position
        var obj = canvas;
        var top = 0;
        var left = 0;
        while (obj && obj.tagName != 'BODY') {
            top += obj.offsetTop;
            left += obj.offsetLeft;
            obj = obj.offsetParent;
        }

        // return relative mouse position
        var mouseX = evt.clientX - left + window.pageXOffset;
        var mouseY = evt.clientY - top + window.pageYOffset;
        return {
            x: mouseX,
            y: mouseY
        };
    }

	var g_drag = {x: 0, y: 0};
	
	function handleMouseEvent(event, isDown, type) {
		var coords = extractMouseCoords(canvas, event);
		g_mouse.x = coords.x;
		g_mouse.y = coords.y;
		g_mouse.down = isDown;
	}

	function handleMouseDown(event) {
		handleMouseEvent(event, true, 'mouseDown');
		
		g_drag = {x: g_mouse.x, y: g_mouse.y};
	}

	function handleMouseUp(event) {
		handleMouseEvent(event, false, 'mouseUp');
	}

	function handleMouseMove(event) {
		handleMouseEvent(event, g_mouse.down, 'mouseMove');
		
		if (g_mouse.down) {
			var dx = g_mouse.x - g_drag.x;
			var dy = g_mouse.y - g_drag.y;
			g_camEntity.camera.rotateAroundTargetHoriz(g_camEntity.transformable, -0.005 * dx);
			g_camEntity.camera.rotateAroundTargetVert(g_camEntity.transformable, -0.01 * dy);
			g_drag = {x: g_mouse.x, y: g_mouse.y};
		}
	}

	g_canvas = document.getElementById('canvas');
	Engine3D.init(g_canvas);
	Engine3D.setClearColor(new Color(0.3, 0.3, 0.3));
	
	g_camEntity = {
		camera: new Camera(0.5 * Math.PI, g_canvas.width / g_canvas.height, 0.01, 1000),
		transformable: new Transformable(new Vecmath.Vector3(0, 5, 10))
	};
	g_camEntity.camera.target = new Vecmath.Vector3(0, 0, 0);
	g_scene = new Scene(new Viewport(), g_camEntity);
	
	g_fpsLabel = {
		renderable: new ScreenTextRenderable(Engine3D, '', new Font('Georgia', 14), Color.white),
		transformable: new Transformable(new Vecmath.Vector3(10, 727, 0))
	};
	g_fpsLabel.renderable.material.luminosity = 1;
	g_scene.addEntity(g_fpsLabel);
	
	g_mousePosLabel = {
		renderable: new ScreenTextRenderable(Engine3D, '', new Font('Georgia', 14), Color.white),
		transformable: new Transformable(new Vecmath.Vector3(800, 727, 0))
	};
	g_mousePosLabel.renderable.material.luminosity = 1;
	g_scene.addEntity(g_mousePosLabel);
	
	const SPRITE_COUNT = 10;
	for (var i = 0; i < SPRITE_COUNT; ++i) {
		var angle = (i / (SPRITE_COUNT - 1) - 0.5) * Math.PI;
		var sprite = {
			renderable: new PointSpriteRenderable(Engine3D, 'data/textures/node.png'),
			transformable: new Transformable(new Vecmath.Vector3(5 * Math.sin(angle), 0, 5 * Math.cos(angle)))
		};
		var mat = sprite.renderable.material;
		mat.color = Color.blue;
		mat.luminosity = 1;
		mat.size = new Vecmath.Vector2(24, 24);
		g_scene.addEntity(sprite);
	}
	
	g_canvas.addEventListener('mousedown', handleMouseDown, false);
	g_canvas.addEventListener('mousemove', handleMouseMove, false);
	g_canvas.addEventListener('mouseup', handleMouseUp, false);
	
	requestAnimFrame(function() { render(); });
	alert('OK');
</script>
</body>
</html>