<html>
<head>
	<title>Hartz Wars IV - Editor</title>
	
	<script src="../math/Matrix3.js" type="text/javascript"></script>
	<script src="../math/Matrix4.js" type="text/javascript"></script>
	<script src="../math/Vector2.js" type="text/javascript"></script>
	<script src="../math/Vector3.js" type="text/javascript"></script>
	<script src="../math/Vector4.js" type="text/javascript"></script>
	<script src="../math/Quaternion.js" type="text/javascript"></script>
	<script src="../math/Ray.js" type="text/javascript"></script>
	<script src="../math/Mathutils.js" type="text/javascript"></script>

	<script src="../3dengine/utils.js" type="text/javascript"></script>
	<script src="../3dengine/fileutils.js" type="text/javascript"></script>
	<script src="../3dengine/webgl_utils.js" type="text/javascript"></script>
	<script src="../3dengine/engine3d.js" type="text/javascript"></script>
	<script src="../3dengine/mesh.js" type="text/javascript"></script>
	<script src="../3dengine/material.js" type="text/javascript"></script>
	<script src="../3dengine/scene.js" type="text/javascript"></script>
	<script src="../3dengine/color.js" type="text/javascript"></script>
	<script src="../3dengine/point_light.js" type="text/javascript"></script>
	<script src="../3dengine/camera.js" type="text/javascript"></script>

	<script src="../3dengine/sprite_renderable.js" type="text/javascript"></script>
	<script src="../3dengine/text_renderable.js" type="text/javascript"></script>
	<script src="../3dengine/transformable.js" type="text/javascript"></script>
	<script src="../3dengine/behaviors_updateable.js" type="text/javascript"></script>

	<script src="../node_ui/hierarchical_view.js" type="text/javascript"></script>
</head>
<body>
<canvas id="canvas" width="1024" height="768"></canvas>

<script>
	const BLUE = new Color(0.6, 0.8, 1.0);
	const HIGHLIGHTED = new Color(1.0, 0.2, 0.2);

	var g_canvas;
	var g_camEntity;
	var g_scene;
	var g_fpsLabel;
	var g_mousePosLabel;
	var lastTime = window.performance.now();
	var g_fps = 0;
	var g_frames = 0;
	var g_framesTime = 0;
	var g_mouse = {x: 0, y: 0, down: false};
	var g_viewport;
	var g_view;
	
	window.requestAnimFrame = (function () {
		return window.requestAnimationFrame ||
			window.webkitRequestAnimationFrame ||
			window.mozRequestAnimationFrame ||
			window.oRequestAnimationFrame ||
			window.msRequestAnimationFrame ||
			function(callback){
				window.setTimeout(callback, 1000 / 60);
			};
	}) ();
	
	function animate() {
		var time = window.performance.now();
		var delta = (time - lastTime) * 0.001;
		lastTime = time;
		
		// update fps
		g_framesTime += delta;
		g_frames++;
		if (g_framesTime > 1.0) {
			g_framesTime -= 1.0;
			g_fps = g_frames;
			g_frames = 0;
		}
		g_fpsLabel.renderable.text = 'FPS: ' + g_fps;
		
		g_mousePosLabel.renderable.text = 'Mouse: (' + g_mouse.x + ', ' + g_mouse.y + ', ' + (g_mouse.down ? 'down' : 'up') + ')';
		
		g_view.update(delta);
		
		Engine3D.clear();
		g_view.render(Engine3D);
		g_scene.render(Engine3D, g_viewport, g_camEntity);
		
		requestAnimFrame( function() { animate(); } );
	}
	
    function extractMouseCoords(canvas, evt){
        // get canvas position
        var obj = canvas;
        var top = 0;
        var left = 0;
        while (obj && obj.tagName != 'BODY') {
            top += obj.offsetTop;
            left += obj.offsetLeft;
            obj = obj.offsetParent;
        }

        // return relative mouse position
        var mouseX = evt.clientX - left + window.pageXOffset;
        var mouseY = evt.clientY - top + window.pageYOffset;
        return {
            x: mouseX,
            y: mouseY
        };
    }

	var g_drag = {x: 0, y: 0};
	var g_click = false;
	
	function handleMouseEvent(event, isDown, type) {
		var coords = extractMouseCoords(canvas, event);
		g_mouse.x = coords.x;
		g_mouse.y = coords.y;
		g_mouse.down = isDown;
		
		g_view[type](g_mouse);
	}

	function handleMouseDown(event) {
		handleMouseEvent(event, true, 'mouseDown');
	}

	function handleMouseUp(event) {
		handleMouseEvent(event, false, 'mouseUp');
	}

	function handleMouseMove(event) {
		handleMouseEvent(event, g_mouse.down, 'mouseMove');
	}

	function start() {
		g_canvas = document.getElementById('canvas');
		
		Engine3D.init(g_canvas);
		Engine3D.setClearColor(new Color(0.1, 0.1, 0.1));
		
		g_viewport = new Viewport();
		g_view = new HierarchicalView(g_viewport);
		
		g_camEntity = { camera: new Camera(), transformable: new Transformable() };
		g_scene = new Scene();
		
		g_fpsLabel = {
			renderable: new ScreenTextRenderable(Engine3D, '', new Font('Georgia', 14), Color.white),
			transformable: new Transformable(new Vecmath.Vector3(10, 727, 0))
		};
		g_scene.addEntity(g_fpsLabel);
		
		g_mousePosLabel = {
			renderable: new ScreenTextRenderable(Engine3D, '', new Font('Georgia', 14), Color.white),
			transformable: new Transformable(new Vecmath.Vector3(800, 727, 0))
		};
		g_scene.addEntity(g_mousePosLabel);
		
		g_canvas.addEventListener('mousedown', handleMouseDown, false);
		g_canvas.addEventListener('mousemove', handleMouseMove, false);
		g_canvas.addEventListener('mouseup', handleMouseUp, false);
		
		requestAnimFrame(function() { animate(); });
	}
	
	start();
</script>
</body>
</html>